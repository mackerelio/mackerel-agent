version: 0.19.{build}
clone_folder: c:\gopath\src\github.com\mackerelio\mackerel-agent
environment:
  GOPATH: c:\gopath
  SIGNTOOL: C:\Program Files (x86)\Microsoft SDKs\Windows\v7.1A\Bin\signtool.exe
  CERT:
    secure: 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
  CERTPASS:
    secure: zCcHe1kV2WqQisMVNCaWSXdBdiHNMCBKSXNJeVEG/gI=
install:
  - md c:\mackerel-secure
  - ps: if ($env:CERT) { Set-Content c:\mackerel-secure\cert.p12.base64 $env:CERT }
  - ps: if ($env:CERTPASS) { Set-Content c:\mackerel-secure\certpass $env:CERTPASS }
  - set PATH=c:\go\bin;%GOPATH%\bin;c:\tools\ruby215\bin;%PATH%;C:\MinGW\bin
  - echo %Path%
  - choco install -y ruby
  - rd c:\go /s /q
  - appveyor DownloadFile https://storage.googleapis.com/golang/go1.9.windows-386.zip
  - 7z x go1.9.windows-386.zip -oC:\ >nul
  - go version
  - go env
  - set CERT= & set CERTPASS= & set
build_script:
  - go get github.com/motemen/go-cli/gen
  - go generate
  - go get golang.org/x/tools/cmd/stringer
  - call wix\build.bat
test_script:
- FOR /F "usebackq" %%w IN (`git rev-parse --show-cdup`) DO SET CDUP=%%w
- cd %CDUP%
- go get -d -v -t ./...
- go tool vet -all .
- go test -short ./...
- call wix\pluginlist_test.bat
notifications:
  - provider: Slack
    auth_token:
      secure: A7QmXiJAvb+wWfCyBXGCDmKpe7mEDywYI7Ai1LLEi8NNAssCJusGjCpHNv7KiRZz
    channel: mackerel
deploy:
  release: $(appveyor_repo_tag_name)
  provider: GitHub
  auth_token:
    secure: nT6f+l3sILrBAyVGLE1il+wkv5BvrnEnVkiPGDZQegePa81MUC4AIDTNQ/gX8AWW
  artifact: mackerel-agent-msi, mackerel-agent-k-msi
  appveyor_repo_tag: true
  force_update: true
  on:
    appveyor_repo_tag: true
artifacts:
  - path: build\mackerel-agent.msi
    name: mackerel-agent-msi
  - path: build\mackerel-agent-k.msi
    name: mackerel-agent-k-msi
