version: 0.19.{build}
clone_folder: c:\gopath\src\github.com\mackerelio\mackerel-agent
environment:
  GOPATH: c:\gopath
  priv_key:
    secure: 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
install:
  - set PATH=c:\go\bin;c:\tools\ruby215\bin;c:\Program Files\OpenSSL\bin\;%PATH%
  - echo %Path%
  - choco install ruby
  - choco install openssl.light
  - which openssl
  - openssl ciphers
  - rd c:\go /s /q
  #- choco install mingw
  - set PATH=%PATH%;C:\MinGW\bin
  - appveyor DownloadFile https://storage.googleapis.com/golang/go1.4.2.windows-386.zip
  - 7z x go1.4.2.windows-386.zip -oC:\ >nul
  - go version
  - go env
  - env
  - ps: $fileContent = "-----BEGIN RSA PRIVATE KEY-----`n"
  - ps: $fileContent += $env:priv_key.Replace(' ', "`n")
  - ps: $fileContent += "`n-----END RSA PRIVATE KEY-----`n"
  - ps: Set-Content c:\users\appveyor\.ssh\id_rsa $fileContent
build_script:
- call wix\build.bat
test_script:
- FOR /F "usebackq" %%w IN (`git rev-parse --show-cdup`) DO SET CDUP=%%w
- cd %CDUP%
- go get -d -v -t ./...
- go vet ./...
- go test -short ./...
notifications:
  - provider: Slack
    auth_token:
      secure: A7QmXiJAvb+wWfCyBXGCDmKpe7mEDywYI7Ai1LLEi8NNAssCJusGjCpHNv7KiRZz
    channel: mackerel
deploy:
  release: $(appveyor_repo_tag_name)
  provider: GitHub
  auth_token:
    secure: nT6f+l3sILrBAyVGLE1il+wkv5BvrnEnVkiPGDZQegePa81MUC4AIDTNQ/gX8AWW
  artifact: mackerel-agent-msi
  appveyor_repo_tag: true
  on:
    appveyor_repo_tag: true
artifacts:
  - path: build\mackerel-agent.msi
    name: mackerel-agent-msi
